#  限流算法

## 固定窗口

> 比较简单。
>
> 设置一个线程安全的自增计数器，周期性清零。
>
> 直接上代码。

```java
//因为我测试类比较简单，日志用的slf4j-simple
//所以要增加几个jvm启动参数设置日志格式
//-Dorg.slf4j.simpleLogger.showDateTime=true 显示日期
//-Dorg.slf4j.simpleLogger.showThreadName=false 不显示线程名称
//-Dorg.slf4j.simpleLogger.showLogName=false 不显示类名
//-Dorg.slf4j.simpleLogger.dateTimeFormat="yyyy-MM-dd HH:mm:ss:SSS" 日期格式
@Slf4j
public class CounterLimiter {
    private Unsafe unsafe;
    private final int limit;
    private long countOffset;
    private int count;

    @SneakyThrows
    public CounterLimiter(int limit, long period) {
        this.limit = limit;
        Field theUnsafe = Unsafe.class.getDeclaredField("theUnsafe");
        theUnsafe.setAccessible(true);
        unsafe = (Unsafe) theUnsafe.get(null);
        this.countOffset = unsafe.objectFieldOffset(CounterLimiter.class.getDeclaredField("count"));
        Timer timer = new Timer("CounterLimiter");
        timer.schedule(new TimerTask() {
            @Override
            public void run() {
                count = 0;
            }
        }, 0L, period);
    }

    /**
     * 能否执行
     */
    public boolean access() {
        int current;
        //自旋锁
        while (!unsafe.compareAndSwapInt(this, countOffset, count, current = count + 1)) ;
        return current <= limit;
    }

    public static void main(String[] args) throws InterruptedException {

        CounterLimiter counterLimiter = new CounterLimiter(20, 1000L);

        //第一批50个同步执行
        IntStream.range(0, 50).parallel().forEach(i -> log.info("第一批：" + i + "-" + (counterLimiter.access() ? "放行" : "拦截")));

        TimeUnit.MILLISECONDS.sleep(1000);

        //第二批50个同步执行
        IntStream.range(0, 50).parallel().forEach(i -> log.info("第二批：" + i + "-" + (counterLimiter.access() ? "放行" : "拦截")));
        new CountDownLatch(1).await();
    }
}
```

结果是

```log
2021-07-08 15:30:47:214 INFO 第一批：28-放行
2021-07-08 15:30:47:214 INFO 第一批：32-放行
2021-07-08 15:30:47:214 INFO 第一批：35-放行
2021-07-08 15:30:47:214 INFO 第一批：22-放行
2021-07-08 15:30:47:214 INFO 第一批：48-放行
2021-07-08 15:30:47:214 INFO 第一批：44-放行
2021-07-08 15:30:47:216 INFO 第一批：36-放行
2021-07-08 15:30:47:214 INFO 第一批：34-放行
2021-07-08 15:30:47:216 INFO 第一批：27-放行
2021-07-08 15:30:47:216 INFO 第一批：19-拦截
2021-07-08 15:30:47:214 INFO 第一批：15-放行
2021-07-08 15:30:47:216 INFO 第一批：45-拦截
2021-07-08 15:30:47:214 INFO 第一批：25-放行
2021-07-08 15:30:47:214 INFO 第一批：26-放行
2021-07-08 15:30:47:214 INFO 第一批：43-放行
2021-07-08 15:30:47:216 INFO 第一批：20-拦截
2021-07-08 15:30:47:214 INFO 第一批：30-放行
2021-07-08 15:30:47:214 INFO 第一批：40-放行
2021-07-08 15:30:47:214 INFO 第一批：3-放行
2021-07-08 15:30:47:216 INFO 第一批：29-拦截
2021-07-08 15:30:47:216 INFO 第一批：37-拦截
2021-07-08 15:30:47:216 INFO 第一批：42-拦截
2021-07-08 15:30:47:216 INFO 第一批：16-拦截
2021-07-08 15:30:47:216 INFO 第一批：24-拦截
2021-07-08 15:30:47:216 INFO 第一批：18-拦截
2021-07-08 15:30:47:216 INFO 第一批：17-拦截
2021-07-08 15:30:47:216 INFO 第一批：21-放行
2021-07-08 15:30:47:216 INFO 第一批：49-拦截
2021-07-08 15:30:47:216 INFO 第一批：33-放行
2021-07-08 15:30:47:214 INFO 第一批：7-放行
2021-07-08 15:30:47:214 INFO 第一批：38-放行
2021-07-08 15:30:47:217 INFO 第一批：0-拦截
2021-07-08 15:30:47:217 INFO 第一批：8-拦截
2021-07-08 15:30:47:217 INFO 第一批：23-拦截
2021-07-08 15:30:47:217 INFO 第一批：31-拦截
2021-07-08 15:30:47:217 INFO 第一批：41-拦截
2021-07-08 15:30:47:217 INFO 第一批：1-拦截
2021-07-08 15:30:47:217 INFO 第一批：2-拦截
2021-07-08 15:30:47:217 INFO 第一批：12-拦截
2021-07-08 15:30:47:217 INFO 第一批：14-拦截
2021-07-08 15:30:47:217 INFO 第一批：46-拦截
2021-07-08 15:30:47:216 INFO 第一批：39-拦截
2021-07-08 15:30:47:216 INFO 第一批：13-拦截
2021-07-08 15:30:47:217 INFO 第一批：10-拦截
2021-07-08 15:30:47:217 INFO 第一批：6-拦截
2021-07-08 15:30:47:217 INFO 第一批：9-拦截
2021-07-08 15:30:47:217 INFO 第一批：11-拦截
2021-07-08 15:30:47:217 INFO 第一批：5-拦截
2021-07-08 15:30:47:217 INFO 第一批：4-拦截
2021-07-08 15:30:47:217 INFO 第一批：47-拦截
2021-07-08 15:30:48:220 INFO 第二批：32-放行
2021-07-08 15:30:48:220 INFO 第二批：7-放行
2021-07-08 15:30:48:220 INFO 第二批：44-放行
2021-07-08 15:30:48:220 INFO 第二批：8-放行
2021-07-08 15:30:48:220 INFO 第二批：45-放行
2021-07-08 15:30:48:220 INFO 第二批：22-放行
2021-07-08 15:30:48:220 INFO 第二批：6-放行
2021-07-08 15:30:48:220 INFO 第二批：47-放行
2021-07-08 15:30:48:220 INFO 第二批：25-放行
2021-07-08 15:30:48:221 INFO 第二批：10-拦截
2021-07-08 15:30:48:220 INFO 第二批：13-放行
2021-07-08 15:30:48:220 INFO 第二批：26-放行
2021-07-08 15:30:48:220 INFO 第二批：40-放行
2021-07-08 15:30:48:220 INFO 第二批：43-放行
2021-07-08 15:30:48:220 INFO 第二批：30-拦截
2021-07-08 15:30:48:220 INFO 第二批：3-放行
2021-07-08 15:30:48:222 INFO 第二批：17-拦截
2021-07-08 15:30:48:221 INFO 第二批：14-拦截
2021-07-08 15:30:48:222 INFO 第二批：16-拦截
2021-07-08 15:30:48:222 INFO 第二批：5-拦截
2021-07-08 15:30:48:222 INFO 第二批：24-拦截
2021-07-08 15:30:48:221 INFO 第二批：11-拦截
2021-07-08 15:30:48:220 INFO 第二批：15-放行
2021-07-08 15:30:48:222 INFO 第二批：9-拦截
2021-07-08 15:30:48:220 INFO 第二批：48-放行
2021-07-08 15:30:48:221 INFO 第二批：46-拦截
2021-07-08 15:30:48:222 INFO 第二批：49-拦截
2021-07-08 15:30:48:222 INFO 第二批：1-拦截
2021-07-08 15:30:48:222 INFO 第二批：34-拦截
2021-07-08 15:30:48:222 INFO 第二批：23-拦截
2021-07-08 15:30:48:222 INFO 第二批：29-拦截
2021-07-08 15:30:48:223 INFO 第二批：20-拦截
2021-07-08 15:30:48:222 INFO 第二批：12-拦截
2021-07-08 15:30:48:223 INFO 第二批：36-拦截
2021-07-08 15:30:48:220 INFO 第二批：35-放行
2021-07-08 15:30:48:220 INFO 第二批：21-拦截
2021-07-08 15:30:48:221 INFO 第二批：19-拦截
2021-07-08 15:30:48:221 INFO 第二批：27-拦截
2021-07-08 15:30:48:221 INFO 第二批：42-拦截
2021-07-08 15:30:48:220 INFO 第二批：33-放行
2021-07-08 15:30:48:220 INFO 第二批：28-放行
2021-07-08 15:30:48:220 INFO 第二批：31-放行
2021-07-08 15:30:48:223 INFO 第二批：39-拦截
2021-07-08 15:30:48:223 INFO 第二批：41-拦截
2021-07-08 15:30:48:223 INFO 第二批：37-拦截
2021-07-08 15:30:48:223 INFO 第二批：38-拦截
2021-07-08 15:30:48:223 INFO 第二批：2-拦截
2021-07-08 15:30:48:223 INFO 第二批：0-拦截
2021-07-08 15:30:48:223 INFO 第二批：18-拦截
2021-07-08 15:30:48:222 INFO 第二批：4-拦截
```

刚好就是第一批放行20个，第二批放行20个。奇怪不奇怪？嗯？