# 规范与重构

## 重构

> 「重构」这个词大家都不陌生。
>
> - 大部分人都是『听得多看得少』。
> - 真正进行过代码重构的人不多。
> - **把持续重构作为开发的一部分的人，更是少之又少。**

一方面，**重构代码是对工程师能力的要求，比单纯写代码高得多。**

重构需要能洞察出代码存在的坏味道或者设计上的不足，并且能合理、熟练地利用设计思想、原则、模式、编程规范等理论知识解决这些问题。

另一方面，**对为什么要重构、到底重构什么、什么时候重构、如何重构等相关问题理解不深。**

对重构没有系统性、全局性的认识，面对一堆烂代码，没有重构技巧的指导，只能想到哪改到哪，并不能全面地改善代码质量。

### 为什么要重构

> 软件设计大师Martin Fowler是这样定义重构的：『**重构是一种对软件内部结构的改善，目的是在不改变软件的可见行为的情况下，使其更容易理解，修改成本更低**』。
>
> 这个定义中有一个值得强调的点『重构不改变外部的可见行为』。我们可以把重构理解为，在保持功能不变的前提下，利用设计思想、原则、模式、编程规范等理论来优化代码，修改设计上的不足，提高代码质量。

首先，**重构是时刻保证代码质量的一个极其有效的手段，不至于让代码腐化到无可救药的地步**。

项目在演进，代码在不停的堆砌。如果没有人为代码的质量负责，代码总是会往越来越混乱的方向演化。当混乱到一定程度之后，量变引起质变，项目的维护成本已经高过重新开发一套新代码的成本，想要再去重构，已经没人能够做到了。

其次，**优秀的代码和框架不是一开始就能完全设计好的**。

就像优秀的公司和产品也都是迭代出来的。我们无法100%预见未来的需求，也没有足够的精力、时间、资源为遥远的未来买单。所以随着系统的演进，重构代码是不可避免的。

最后，**重构是避免过度设计的有效手段**。

在我们维护代码的过程中，真正遇到问题的时候再对代码进行重构，能有效避免前期投入太多时间做过度的设计，能够有的放矢。

**除此之代，重构对一个工程师本身技术的成长也有重要的意义。**

- 重构实际上是对我们学习的经典设计思想、设计原则、设计模式、编程规范的一种应用。重构是一个很好的能够锻炼我们熟练使用这些理论知识能力的实践场景。

- 平时堆砌业务逻辑，总会觉得没啥成长。而将一个比较烂的代码重构成一个比较好的代码，会很有成就感。

- 重构能力也是衡量一个工程师代码能力的有效手段。

  所谓「初级工程师在维护代码，高级工程师在设计代码，资深工程师在重构代码」，这句话意思就是说：

  初级工程师在已有代码框架下修改bug，修改添加功能代码。

  高级工程师从零开始设计代码结构、搭建代码框架。

  资深工程师为代码质量负责，需要发掘代码存在的问题，重构代码，时刻保持代码质量处于一个可控的状态。

  > 当然，这里的初级、高级、资深只是一个相对的概念，并不是一个确定的职级。

### 到底重构什么

> 根据重构的规模，可以笼统的分为大规模高层次重构「大重构」和小规模低层次重构「小重构」。

**大重构**，指的是对顶层代码设计的重构。

- 重构目标：包括系统、模块、代码结构、类与类之间的关系等。
- 重构手段：分层、模块化、解耦、抽象可复用组件等等。
- 重构工具：设计思想、设计原则和经典设计模式。

涉及改动代码会比较多，影响面比较大，难度也不较大，耗时会比较长，引入bug的风险也就比较大。

**小重构**，指的是对代码细节的重构。

- 重构目标：主要针对类、函数、变量等代码级别的重构。
- 重构手段：规范命名、规范注释、消除超大类或函数、提取重复代码等等。
- 重构工具：编码规范。

修改的地方比较集中，比较简单，可操作性强，耗时比较短，引入bug的封箱相对来说比较小。

### 什么时候重构

> 是代码烂到一定程度之后才去重构吗？不是。
>
> 当代码真的烂到出现「开发效率低，招了很多人，天天加班，出活却不多，线上bug频发，领导发飙，中层束手无策，工程师抱怨不断，查找bug困难」的时候，基本上重构也无法解决问题了。

平时不注重代码质量，堆砌烂代码，是在维护不了了再大刀阔斧的重构、甚至重写。这样是不行的，有的时候项目代码太多，重构很难做的彻底，最后又搞出来一个「四不像」的怪物，那就更麻烦了。

寄希望于在代码烂到一定程度之后，集中重构解决所有问题是不现实的，我们必须探索一条『**可持续、可演进**』的方式：**==持续重构==**。平时没有事情的时候，看看项目中有哪些写的不够好的、可以优化的代码，主动重构一下。或者，在修改、添加某个功能代码的时候，顺手把不符合编码规范、不好的设计重构一下。就像把单元测试、Code Review作为开发的一部分，我们如果能把持续重构也作为开发的一部分，成为一种开发习惯，对项目、对自己都会很有好处。

**重构的能力很重要，但持续重构的意识更重要**。

技术在更新、需求在变化、人员在流动，代码质量总会下降，代码总会存在不完美，重构就会持续在进行。

时刻具有持续重构意识，才能避免开发初期就过度设计，避免代码维护过程中的质量下降。

而那些看到别人代码有点瑕疵就一顿乱骂，或者花尽心思去构思一个完美设计的人，往往都是因为没有树立正确的代码质量观，没有持续重构意识。

### 如何重构

- 对于大重构来说。

  涉及模块、代码比较多，如果代码质量比较差，耦合比较严重，往往牵一发而动全身。

  > 如果计划一天完成，你会发现越改越多、越改越乱。而新的业务开发又与重构相冲突，最后只能半途而废，revert调所有的改动，很失落的又去堆砌烂代码了。
  >
  
  要提前做好完善的重构计划，有条不紊的分阶段来进行。每个阶段完成一小部分代码的重构，然后提交、测试、运行，发现没有问题之后，再继续进行下一阶段的重构，保证代码仓库的代码一直处于可运行、逻辑正确的状态。每个阶段我们都要控制好重构影响到的代码范围，考虑好如何兼容老代码的逻辑，必须的时候还需要写一些兼容过度代码。
  
  只有这样我们才能让每一阶段的重构不至于耗时太长「最好一天就能完成」，不至于与新功能开发相冲突。
  
  大规模高层次的重构一定是有组织、有计划，并且非常谨慎的，需要有经验、熟悉业务的资深同事来主导。
  
- 对于小重构来说。

  影响范围小，改动耗时短。所以只要有时间且愿意，随时都可以去做。

  除了人工去发现低层次的代码问题，还可以借助很多乘数的静态代码分析工具「比如CheckStyle、FindBugs、PMD、sonar等」来自动发现代码中的问题，然后针对性的进行重构优化。

> 对于重构这件事情，资深的工程师、项目 leader 要负起责任来，没事就重构一下代码，时刻保证代码质量处在一个良好的状态。否则，一旦出现“破窗效应”，一个人往里堆了一些烂代码，之后就会有更多的人往里堆更烂的代码。毕竟往项目里堆砌烂代码的成本太低了。不过，保持代码质量最好的方法还是打造一种好的技术氛围，以此来驱动大家主动去关注代码质量，持续重构代码。

## 可测试性

## 解耦

## 快速改善代码质量的20条编程规范

