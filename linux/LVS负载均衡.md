# LVS

LVS（Linux Virtual Server）既是一种负载均衡的思想，也是一个具体可以实现负载均衡的工具。作为一个思想，LVS代表了使用Linux系统构建的虚拟服务器技术，目的是通过分发网络服务请求到后端多个服务器，实现服务的高性能和高可用性。这种思想基于将请求按照一定的算法分配给后端服务器集群，以达到负载均衡的目的，同时提供故障转移和服务的无缝切换功能。

作为一个工具，LVS是一个成熟的、开源的负载均衡软件，它提供了具体的实现机制来支持上述负载均衡的思想。LVS允许管理员配置和管理一组服务器，使之作为一个整体对外提供服务。它支持多种负载均衡算法（如轮询、加权轮询、最少连接等），以及多种工作模式（如NAT、直接路由DR、隧道TUN等），能够根据实际需求灵活部署。

简而言之，LVS既是指一套基于Linux的负载均衡解决方案的总体概念，也指具体实现这一概念的软件工具。这使得LVS在构建高性能、高可用的网络服务架构方面，成为了一个非常重要和实用的选项。

## 使用及验证

我有三台虚拟机「13.133.222.3/13.133.222.4/13.133.222.5」可以将一台虚拟机作为LVS调度器（负载均衡器），其他两台作为真实服务器（后端服务器）。这里，我们假设13.133.222.3作为LVS调度器，13.133.222.4和13.133.222.5作为后端服务器。以下是一个基于LVS的简单配置示例，我们将采用LVS的NAT模式进行配置。

### 环境准备

- LVS调度器（Load Balancer）：13.133.222.3
- 真实服务器1：13.133.222.4
- 真实服务器2：13.133.222.5
- 虚拟服务IP（VIP）：13.133.222.13（假设）
- 服务端口：80（HTTP服务为例）

### 步骤1：配置LVS调度器

1. **安装ipvsadm工具**（在13.133.222.3上执行）

   ```bash
   sudo yum install ipvsadm -y
   ```

2. **配置LVS规则**（选择NAT模式，以HTTP服务为例）

   ```bash
   # 添加虚拟服务
   sudo ipvsadm -A -t 13.133.222.13:80 -s rr
   
   # 添加真实服务器
   sudo ipvsadm -a -t 13.133.222.13:80 -r 13.133.222.4:80 -m
   sudo ipvsadm -a -t 13.133.222.13:80 -r 13.133.222.5:80 -m
   ```

   这里`-s rr`表示使用轮询（round-robin）算法，`-m`表示NAT模式。

3. **启用IP转发**（确保LVS调度器能够转发包）

   ```bash
   echo 1 | sudo tee /proc/sys/net/ipv4/ip_forward
   ```

### 步骤2：配置真实服务器

对于13.133.222.4和13.133.222.5上的每台服务器，确保它们能够处理转发到它们的请求。在NAT模式下，服务器需要将返回流量路由到LVS调度器。这通常意味着调整默认网关或特定路由，使得回应客户端的流量通过LVS调度器。

1. **配置默认网关**（或特定路由，以13.133.222.3为网关）

   ```bash
   sudo ip route add default via 13.133.222.3
   ```

2. **配置和启动Web服务**（确保两台后端服务器都运行了HTTP服务）

   ```bash
   # 以安装和启动Apache HTTP服务器为例
   sudo yum install httpd -y
   echo "Hello from $(hostname)" | sudo tee /var/www/html/index.html
   sudo systemctl start httpd
   sudo systemctl enable httpd
   ```

### 步骤3：验证配置

1. **查看LVS规则**

   ```bash
   sudo ipvsadm -Ln
   ```

2. **从客户端测试**

   访问虚拟服务IP（13.133.222.13）上的HTTP服务，可以使用浏览器或命令行工具如`curl`：

   ```bash
   curl http://13.133.222.13
   ```

   多次执行这个命令应该可以看到请求被轮流分发到两台真实服务器。

![image-20240225175231438](https://wangigor-typora-images.oss-cn-chengdu.aliyuncs.com/image-20240225175231438.png)



LVS（Linux Virtual Server）提供了多种负载均衡算法，以支持不同的场景和需求。

### 1. 轮询（Round-Robin, RR）

- **原理**：按顺序依次将新的连接请求分配给服务器列表中的每一台服务器。当到达列表末尾时，再从头开始。
- **适用场景**：适用于所有服务器配置相同，处理能力相似的环境。

### 2. 加权轮询（Weighted Round-Robin, WRR）

- **原理**：与轮询类似，但每台服务器可以分配不同的权重。服务器每次被选中时，其权重会减1，直到减到0为止，然后重新分配权重。权重较高的服务器会接收更多的连接请求。
- **适用场景**：适用于服务器的配置和处理能力不均匀的环境，可以根据服务器的能力给予不同的权重。

### 3. 最少连接（Least-Connection, LC）

- **原理**：新的连接请求被分配给当前活跃连接数最少的服务器。
- **适用场景**：适用于处理时间波动较大的请求，能够动态地响应后端服务器的负载变化。

### 4. 加权最少连接（Weighted Least-Connection, WLC）

- **原理**：在最少连接的基础上，考虑服务器的权重。选择活跃连接数相对于权重最少的服务器。
- **适用场景**：适用于服务器性能不均且请求处理时间不确定的环境。

### 5. 基于局部性的最少连接（Locality-Based Least-Connection, LBLC）

- **原理**：尝试将来自同一源地址的请求分配给同一台服务器，如果该服务器不可用或过载，则根据最少连接原则选择另一台服务器。
- **适用场景**：适用于需要会话保持的应用，如Web应用的会话信息。

### 6. 基于局部性的加权最少连接（Locality-Based Weighted Least-Connection, LBLCR）

- **原理**：是LBLC的加权版本，不仅考虑局部性和连接数，还考虑服务器的权重。
- **适用场景**：适用于处理能力不均且需要会话保持的场景。

### 7. 目标地址散列（Destination Hashing, DH）

- **原理**：根据请求的目标IP地址进行散列计算，根据计算结果分配给特定的服务器。
- **适用场景**：适用于请求分布需要均匀且稳定分配到后端服务器的环境。

### 8. 源地址散列（Source Hashing, SH）

- **原理**：根据请求的源IP地址进行散列计算，根据计算结果分配给特定的服务器。
- **适用场景**：适用于需要会话保持，确保来自同一源地址的请求被分配到同一服务器的环境。

每种算法都有其特定的使用场景和优势。在选择负载均衡算法时，需要根据实际应用的需求、后端服务器的配置和处理能力，以及请求的特性来决定最适合的算法。