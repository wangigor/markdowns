# LVS

LVS（Linux Virtual Server）既是一种负载均衡的思想，也是一个具体可以实现负载均衡的工具。作为一个思想，LVS代表了使用Linux系统构建的虚拟服务器技术，目的是通过分发网络服务请求到后端多个服务器，实现服务的高性能和高可用性。这种思想基于将请求按照一定的算法分配给后端服务器集群，以达到负载均衡的目的，同时提供故障转移和服务的无缝切换功能。

作为一个工具，LVS是一个成熟的、开源的负载均衡软件，它提供了具体的实现机制来支持上述负载均衡的思想。LVS允许管理员配置和管理一组服务器，使之作为一个整体对外提供服务。它支持多种负载均衡算法（如轮询、加权轮询、最少连接等），以及多种工作模式（如NAT、直接路由DR、隧道TUN等），能够根据实际需求灵活部署。

简而言之，LVS既是指一套基于Linux的负载均衡解决方案的总体概念，也指具体实现这一概念的软件工具。这使得LVS在构建高性能、高可用的网络服务架构方面，成为了一个非常重要和实用的选项。

## 使用及验证

我有三台虚拟机「13.133.222.3/13.133.222.4/13.133.222.5」可以将一台虚拟机作为LVS调度器（负载均衡器），其他两台作为真实服务器（后端服务器）。这里，我们假设13.133.222.3作为LVS调度器，13.133.222.4和13.133.222.5作为后端服务器。以下是一个基于LVS的简单配置示例，我们将采用LVS的NAT模式进行配置。

### 环境准备

- LVS调度器（Load Balancer）：13.133.222.3
- 真实服务器1：13.133.222.4
- 真实服务器2：13.133.222.5
- 虚拟服务IP（VIP）：13.133.222.13（假设）
- 服务端口：80（HTTP服务为例）

### 步骤1：配置LVS调度器

1. **安装ipvsadm工具**（在13.133.222.3上执行）

   ```bash
   sudo yum install ipvsadm -y
   ```

2. **配置LVS规则**（选择NAT模式，以HTTP服务为例）

   ```bash
   # 添加虚拟服务
   sudo ipvsadm -A -t 13.133.222.13:80 -s rr
   
   # 添加真实服务器
   sudo ipvsadm -a -t 13.133.222.13:80 -r 13.133.222.4:80 -m
   sudo ipvsadm -a -t 13.133.222.13:80 -r 13.133.222.5:80 -m
   ```

   这里`-s rr`表示使用轮询（round-robin）算法，`-m`表示NAT模式。

3. **启用IP转发**（确保LVS调度器能够转发包）

   ```bash
   echo 1 | sudo tee /proc/sys/net/ipv4/ip_forward
   ```

### 步骤2：配置真实服务器

对于13.133.222.4和13.133.222.5上的每台服务器，确保它们能够处理转发到它们的请求。在NAT模式下，服务器需要将返回流量路由到LVS调度器。这通常意味着调整默认网关或特定路由，使得回应客户端的流量通过LVS调度器。

1. **配置默认网关**（或特定路由，以13.133.222.3为网关）

   ```bash
   sudo ip route add default via 13.133.222.3
   ```

2. **配置和启动Web服务**（确保两台后端服务器都运行了HTTP服务）

   ```bash
   # 以安装和启动Apache HTTP服务器为例
   sudo yum install httpd -y
   echo "Hello from $(hostname)" | sudo tee /var/www/html/index.html
   sudo systemctl start httpd
   sudo systemctl enable httpd
   ```

### 步骤3：验证配置

1. **查看LVS规则**

   ```bash
   sudo ipvsadm -Ln
   ```

2. **从客户端测试**

   访问虚拟服务IP（13.133.222.13）上的HTTP服务，可以使用浏览器或命令行工具如`curl`：

   ```bash
   curl http://13.133.222.13
   ```

   多次执行这个命令应该可以看到请求被轮流分发到两台真实服务器。

![image-20240225175231438](https://wangigor-typora-images.oss-cn-chengdu.aliyuncs.com/image-20240225175231438.png)