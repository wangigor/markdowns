# 字节码增强



## 字节码

> .java文件是程序员能「使用」的文件。.class文件是java虚拟机能「使用」的文件。
>
> .java文件经过编译「javac」之后，转换成.class文件。先来了解一下class文件结构。

首先随便写两个java文件。

- 父类

```java
package cn.igor.apm.demo;

public class BaseCode {

    public static final String key="temp_key";

    private int pField;

    public int getpField() {
        return pField;
    }

    public void setpField(int pField) {
        this.pField = pField;
    }

}
```

- 子类

```java
package cn.igor.apm.demo;

public class ByteCode extends BaseCode {

    private String cField;

    public String getcField() {
        return cField;
    }

    public void setcField(String cField) {
        this.cField = cField;
    }

    @Override
    public int getpField() {
        return super.getpField();
    }

    //测试
    public static int test() {
        int a = 1;
        int b = 2;
        return a + b;
    }

    public static void main(String[] args) {
        test();
    }
}
```

通过```javac ByteCode.java BaseCode.java ```编译得到两个对应的class文件。

> 这是两个二进制文件，我们先使用二进制打开它看看他的结构。
>
> 可以使用sublime，也可以使用vi
>
> ```bash
> # -b 以二进制显示
> vi -b baseCode.class
> #全部替换为16进制显示
> :%!xxd 
> ```

```hexadecimal
# BaseCode.class
00000000: cafe babe 0000 0034 001a 0a00 0400 1509  .......4........
00000010: 0003 0016 0700 1707 0018 0100 036b 6579  .............key
00000020: 0100 124c 6a61 7661 2f6c 616e 672f 5374  ...Ljava/lang/St
00000030: 7269 6e67 3b01 000d 436f 6e73 7461 6e74  ring;...Constant
00000040: 5661 6c75 6508 0019 0100 0670 4669 656c  Value......pFiel
00000050: 6401 0001 4901 0006 3c69 6e69 743e 0100  d...I...<init>..
00000060: 0328 2956 0100 0443 6f64 6501 000f 4c69  .()V...Code...Li
00000070: 6e65 4e75 6d62 6572 5461 626c 6501 0009  neNumberTable...
00000080: 6765 7470 4669 656c 6401 0003 2829 4901  getpField...()I.
00000090: 0009 7365 7470 4669 656c 6401 0004 2849  ..setpField...(I
000000a0: 2956 0100 0a53 6f75 7263 6546 696c 6501  )V...SourceFile.
000000b0: 000d 4261 7365 436f 6465 2e6a 6176 610c  ..BaseCode.java.
000000c0: 000b 000c 0c00 0900 0a01 0019 636e 2f69  ............cn/i
000000d0: 676f 722f 6170 6d2f 6465 6d6f 2f42 6173  gor/apm/demo/Bas
000000e0: 6543 6f64 6501 0010 6a61 7661 2f6c 616e  eCode...java/lan
000000f0: 672f 4f62 6a65 6374 0100 0874 656d 705f  g/Object...temp_
00000100: 6b65 7900 2100 0300 0400 0000 0200 1900  key.!...........
00000110: 0500 0600 0100 0700 0000 0200 0800 0200  ................
00000120: 0900 0a00 0000 0300 0100 0b00 0c00 0100  ................
00000130: 0d00 0000 1d00 0100 0100 0000 052a b700  .............*..
00000140: 01b1 0000 0001 000e 0000 0006 0001 0000  ................
00000150: 0003 0001 000f 0010 0001 000d 0000 001d  ................
00000160: 0001 0001 0000 0005 2ab4 0002 ac00 0000  ........*.......
00000170: 0100 0e00 0000 0600 0100 0000 0a00 0100  ................
00000180: 1100 1200 0100 0d00 0000 2200 0200 0200  ..........".....
00000190: 0000 062a 1bb5 0002 b100 0000 0100 0e00  ...*............
000001a0: 0000 0a00 0200 0000 0e00 0500 0f00 0100  ................
000001b0: 1300 0000 0200 14                        .......
```

```hexadecimal
# ByteCode.class
00000000: cafe babe 0000 0034 001e 0a00 0600 1809  .......4........
00000010: 0005 0019 0a00 0600 1a0a 0005 001b 0700  ................
00000020: 1c07 001d 0100 0663 4669 656c 6401 0012  .......cField...
00000030: 4c6a 6176 612f 6c61 6e67 2f53 7472 696e  Ljava/lang/Strin
00000040: 673b 0100 063c 696e 6974 3e01 0003 2829  g;...<init>...()
00000050: 5601 0004 436f 6465 0100 0f4c 696e 654e  V...Code...LineN
00000060: 756d 6265 7254 6162 6c65 0100 0967 6574  umberTable...get
00000070: 6346 6965 6c64 0100 1428 294c 6a61 7661  cField...()Ljava
00000080: 2f6c 616e 672f 5374 7269 6e67 3b01 0009  /lang/String;...
00000090: 7365 7463 4669 656c 6401 0015 284c 6a61  setcField...(Lja
000000a0: 7661 2f6c 616e 672f 5374 7269 6e67 3b29  va/lang/String;)
000000b0: 5601 0009 6765 7470 4669 656c 6401 0003  V...getpField...
000000c0: 2829 4901 0004 7465 7374 0100 046d 6169  ()I...test...mai
000000d0: 6e01 0016 285b 4c6a 6176 612f 6c61 6e67  n...([Ljava/lang
000000e0: 2f53 7472 696e 673b 2956 0100 0a53 6f75  /String;)V...Sou
000000f0: 7263 6546 696c 6501 000d 4279 7465 436f  rceFile...ByteCo
00000100: 6465 2e6a 6176 610c 0009 000a 0c00 0700  de.java.........
00000110: 080c 0011 0012 0c00 1300 1201 0019 636e  ..............cn
00000120: 2f69 676f 722f 6170 6d2f 6465 6d6f 2f42  /igor/apm/demo/B
00000130: 7974 6543 6f64 6501 0019 636e 2f69 676f  yteCode...cn/igo
00000140: 722f 6170 6d2f 6465 6d6f 2f42 6173 6543  r/apm/demo/BaseC
00000150: 6f64 6500 2100 0500 0600 0000 0100 0200  ode.!...........
00000160: 0700 0800 0000 0600 0100 0900 0a00 0100  ................
00000170: 0b00 0000 1d00 0100 0100 0000 052a b700  .............*..
00000180: 01b1 0000 0001 000c 0000 0006 0001 0000  ................
00000190: 0003 0001 000d 000e 0001 000b 0000 001d  ................
000001a0: 0001 0001 0000 0005 2ab4 0002 b000 0000  ........*.......
000001b0: 0100 0c00 0000 0600 0100 0000 0800 0100  ................
000001c0: 0f00 1000 0100 0b00 0000 2200 0200 0200  ..........".....
000001d0: 0000 062a 2bb5 0002 b100 0000 0100 0c00  ...*+...........
000001e0: 0000 0a00 0200 0000 0c00 0500 0d00 0100  ................
000001f0: 1100 1200 0100 0b00 0000 1d00 0100 0100  ................
00000200: 0000 052a b700 03ac 0000 0001 000c 0000  ...*............
00000210: 0006 0001 0000 0011 0009 0013 0012 0001  ................
00000220: 000b 0000 0028 0002 0002 0000 0008 043b  .....(.........;
00000230: 053c 1a1b 60ac 0000 0001 000c 0000 000e  .<..`...........
00000240: 0003 0000 0016 0002 0017 0004 0018 0009  ................
00000250: 0014 0015 0001 000b 0000 0021 0001 0001  ...........!....
00000260: 0000 0005 b800 0457 b100 0000 0100 0c00  .......W........
00000270: 0000 0a00 0200 0000 1c00 0400 1d00 0100  ................
00000280: 1600 0000 0200 17                        .......
```

### 约定结构

> 参考[wiki_java_class_file](https://en.wikipedia.org/wiki/Java_class_file#General_layout)。

<table class="wikitable"><table><tbody><tr>
<th>byte offset
</th>
<th>size
</th>
<th>type or value
</th>
<th>description
</th></tr>
<tr>
<td>0
</td>
<td rowspan="4">4 bytes
</td>
<td>u1 =<br>0xCA hex
</td>
<td rowspan="4"><a href="/wiki/Magic_number_(programming)" title="Magic number (programming)">magic number</a> (CAFEBABE) used to identify file as conforming to the class file format
<br/>前四字节是CAFEBABE的魔数。就像标记了文件类型，这是一个符合jvm规范的class文件的开头。
</td></tr>
<tr>
<td>1
</td>
<td>u1 =<br>0xFE hex
</td></tr>
<tr>
<td>2
</td>
<td>u1 =<br>0xBA hex
</td></tr>
<tr>
<td>3
</td>
<td>u1 =<br>0xBE hex
</td></tr>
<tr>
<td>4
</td>
<td rowspan="2">2 bytes
</td>
<td rowspan="2">u2
</td>
<td rowspan="2">minor version number of the class file format being used
 <br/>这是jdk的小版本号。我们上面两个00000034，前面0000说明没有小版本区别。
</td></tr>
<tr>
<td>5
</td></tr>
<tr>
<td>6
</td>
<td rowspan="2">2 bytes
</td>
<td rowspan="2">u2
</td>
<td rowspan="2">major version number of the class file format being used.<br>
  JDK的主版本号。这里经常会碰到的错误就是「unsupported major.minor version 52.0」说明当前这个class是通过java8编译的，而当前环境的jdk版本低于java8，不能兼容。
<p>Java SE 17 = 61 (0x3D hex)<br> 
Java SE 16 = 60 (0x3C hex),<br>
Java SE 15 = 59 (0x3B hex),<br>
Java SE 14 = 58 (0x3A hex),<br>
Java SE 13 = 57 (0x39 hex),<br>
Java SE 12 = 56 (0x38 hex),<br>
Java SE 11 = 55 (0x37 hex),<br>
Java SE 10 = 54 (0x36 hex),<sup id="cite_ref-3" class="reference"><a href="#cite_note-3">[3]</a></sup><br>
Java SE 9 = 53 (0x35 hex),<sup id="cite_ref-4" class="reference"><a href="#cite_note-4">[4]</a></sup><br>
Java SE 8 = 52 (0x34 hex),<br>Java SE 7 = 51 (0x33 hex),<br>Java SE 6.0 = 50 (0x32 hex),<br>Java SE 5.0 = 49 (0x31 hex),<br>JDK 1.4 = 48 (0x30 hex),<br>JDK 1.3 = 47 (0x2F hex),<br>JDK 1.2 = 46 (0x2E hex),<br>JDK 1.1 = 45 (0x2D hex).<br>For details of earlier version numbers see footnote 1 at <a rel="nofollow" class="external text" href="https://docs.oracle.com/javase/specs/jvms/se6/html/ClassFile.doc.html">The JavaTM Virtual Machine Specification 2nd edition</a>
</p>
</td></tr>
<tr>
<td>7
</td></tr>
<tr>
<td>8
</td>
<td rowspan="2">2 bytes
</td>
<td rowspan="2">u2
</td>
<td rowspan="2">constant pool count, number of entries in the following constant pool table.  This count is at least one greater than the actual number of entries; see following discussion.
<br/>这里标记了常量池的大小。我们看到上面class的一个常量池大小分别是001a「25」和001e「29」。这里似乎有两个违反常识的点。
<br/>一个是「都减了1：1a应该是26；1e应该是30」，wiki百科里说这是因为「文件格式开发过程中的历史选择」，或许可以理解为nextCurrentIndex。
<br/>另一个是「为啥不是+1，因为我们通常的计数都是从0开始」，这是因为索引0标识无效「null」不引用任何索引。
</td></tr>
<tr>
<td>9
</td></tr>
<tr>
<td>10
</td>
<td rowspan="4"><i>cpsize</i> (variable)
</td>
<td rowspan="4">table
</td>
<td rowspan="4">constant pool table, an array of variable-sized constant pool entries, containing items such as literal numbers, strings, and references to classes or methods.  Indexed starting at 1, containing (<i>constant pool count</i> - 1) number of entries in total (see note).
<br/>详见常量池结构
</td></tr>
<tr>
<td>...
</td></tr>
<tr>
<td>...
</td></tr>
<tr>
<td>...
</td></tr>
<tr>
<td>10+<i>cpsize</i>
</td>
<td rowspan="2">2 bytes
</td>
<td rowspan="2">u2
</td>
<td rowspan="2">access flags, a bitmask
<br/>访问标识的config，固定16位，不同的位代表不同的访问控制是否开启
<br/>详见访问标识。
</td></tr>
<tr>
<td>11+<i>cpsize</i>
</td></tr>
<tr>
<td>12+<i>cpsize</i>
</td>
<td rowspan="2">2 bytes
</td>
<td rowspan="2">u2
</td>
<td rowspan="2">identifies <i>this</i> class, index into the constant pool to a "Class"-type entry
</td></tr>
<tr>
<td>13+<i>cpsize</i>
</td></tr>
<tr>
<td>14+<i>cpsize</i>
</td>
<td rowspan="2">2 bytes
</td>
<td rowspan="2">u2
</td>
<td rowspan="2">identifies <i>super</i> class, index into the constant pool to a "Class"-type entry
</td></tr>
<tr>
<td>15+<i>cpsize</i>
</td></tr>
<tr>
<td>16+<i>cpsize</i>
</td>
<td rowspan="2">2 bytes
</td>
<td rowspan="2">u2
</td>
<td rowspan="2">interface count, number of entries in the following interface table
</td></tr>
<tr>
<td>17+<i>cpsize</i>
</td></tr>
<tr>
<td>18+<i>cpsize</i>
</td>
<td rowspan="4"><i>isize</i> (variable)
</td>
<td rowspan="4">table
</td>
<td rowspan="4">interface table: a variable-length array of constant pool indexes describing the interfaces implemented by this class
</td></tr>
<tr>
<td>...
</td></tr>
<tr>
<td>...
</td></tr>
<tr>
<td>...
</td></tr>
<tr>
<td>18+<i>cpsize</i>+<i>isize</i>
</td>
<td rowspan="2">2 bytes
</td>
<td rowspan="2">u2
</td>
<td rowspan="2">field count, number of entries in the following field table
</td></tr>
<tr>
<td>19+<i>cpsize</i>+<i>isize</i>
</td></tr>
<tr>
<td>20+<i>cpsize</i>+<i>isize</i>
</td>
<td rowspan="4"><i>fsize</i> (variable)
</td>
<td rowspan="4">table
</td>
<td rowspan="4">field table, variable length array of fields
<p>each element is a field_info structure defined in <a rel="nofollow" class="external free" href="https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-4.html#jvms-4.5">https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-4.html#jvms-4.5</a>
</p>
</td></tr>
<tr>
<td>...
</td></tr>
<tr>
<td>...
</td></tr>
<tr>
<td>...
</td></tr>
<tr>
<td>20+<i>cpsize</i>+<i>isize</i>+<i>fsize</i>
</td>
<td rowspan="2">2 bytes
</td>
<td rowspan="2">u2
</td>
<td rowspan="2">method count, number of entries in the following method table
</td></tr>
<tr>
<td>21+<i>cpsize</i>+<i>isize</i>+<i>fsize</i>
</td></tr>
<tr>
<td>22+<i>cpsize</i>+<i>isize</i>+<i>fsize</i>
</td>
<td rowspan="4"><i>msize</i> (variable)
</td>
<td rowspan="4">table
</td>
<td rowspan="4">method table, variable length array of methods each element is a method_info structure defined in <a rel="nofollow" class="external free" href="https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-4.html#jvms-4.6">https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-4.html#jvms-4.6</a></td></tr>
<tr>
<td>...
</td></tr>
<tr>
<td>...
</td></tr>
<tr>
<td>...
</td></tr>
<tr>
<td>22+<i>cpsize</i>+<i>isize</i>+<i>fsize</i>+<i>msize</i>
</td>
<td rowspan="2">2 bytes
</td>
<td rowspan="2">u2
</td>
<td rowspan="2">attribute count, number of entries in the following attribute table
</td></tr>
<tr>
<td>23+<i>cpsize</i>+<i>isize</i>+<i>fsize</i>+<i>msize</i>
</td></tr>
<tr>
<td>24+<i>cpsize</i>+<i>isize</i>+<i>fsize</i>+<i>msize</i>
</td>
<td rowspan="4"><i>asize</i> (variable)
</td>
<td rowspan="4">table
</td>
<td rowspan="4">attribute table, variable length array of attributes<p>each element is an attribute_info structure defined in <a rel="nofollow" class="external free" href="https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-4.html#jvms-4.7">https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-4.html#jvms-4.7</a>
</p>
</td></tr>
<tr>
<td>...
</td></tr>
<tr>
<td>...
</td></tr>
<tr>
<td>...
</td></tr></tbody></table>

### 常量池结构

> 资料来自[美团技术团队](https://tech.meituan.com/2019/09/05/java-bytecode-enhancement.html)。
>
> 举个例子：BaseCode.class的常量池计数器后面的第一个字节0a「十进制10」,对应CONSTANT_Methodref_info。后面有4个字节，前两个标识CONSTANT_Class_info的常量池索引0004「4」；后两个标识CONSTANT_NameAndType的常量池索引0015「21」。
>
> 这个常量池数据不是固定长度的，要根据具体情况而定。
>
> 在BaseCode.class「因为数据少」里共有25个常量信息，分别是
>
> ```text
> 0a 0004 0015
> 09 0003 0016
> 07 0017
> 07 0018
> 01 0003 6b6579
> 01 0012 4c6a6176612f6c616e672f537472696e673b
> 01 000d 436f6e7374616e7456616c7565
> 08 0019
> 01 0006 6704669656c64
> 01 0001 49
> 01 0006 3c696e69743e
> 01 0003 282956
> 01 0004 436f6465
> 01 000f 4c696e654e756d6265725461626c65
> 01 0009 676574704669656c64
> 01 0003 282949
> 01 0009 736574704669656c64
> 01 0004 28492956
> 01 000a 536f7572636546696c65
> 01 000d 42617365436f64652e6a617661
> 0c 000b 000c
> 0c 0009 000a
> 01 0019 636e2f69676f722f61706d2f64656d6f2f42617365436f6465
> 01 0010 6a6176612f6c616e672f4f626a656374
> 01 0008 74656d705f6b6579
> ```
>
> 了解就好。

![图6 各类型的cp_info](https://gitee.com/wangigor/typora-images/raw/master/f5bdc7e8203ec666a531fcd19cdbcddc519208.png)

### 访问标识

> 16位，与16个MASK进行位运算，就知道当前访问控制的组合。

![image-20210728224829661](https://gitee.com/wangigor/typora-images/raw/master/image-20210728224829661.png)

在Modifier.java里有对应的代码。下面只把这16个mask列出来。

```java
/*
 * Access modifier flag constants from tables 4.1, 4.4, 4.5, and 4.7 of
 * <cite>The Java&trade; Virtual Machine Specification</cite>
 */

/**
 * The {@code int} value representing the {@code public}
 * modifier.
 */
public static final int PUBLIC           = 0x00000001;

/**
 * The {@code int} value representing the {@code private}
 * modifier.
 */
public static final int PRIVATE          = 0x00000002;

/**
 * The {@code int} value representing the {@code protected}
 * modifier.
 */
public static final int PROTECTED        = 0x00000004;

/**
 * The {@code int} value representing the {@code static}
 * modifier.
 */
public static final int STATIC           = 0x00000008;

/**
 * The {@code int} value representing the {@code final}
 * modifier.
 */
public static final int FINAL            = 0x00000010;

/**
 * The {@code int} value representing the {@code synchronized}
 * modifier.
 */
public static final int SYNCHRONIZED     = 0x00000020;

/**
 * The {@code int} value representing the {@code volatile}
 * modifier.
 */
public static final int VOLATILE         = 0x00000040;

/**
 * The {@code int} value representing the {@code transient}
 * modifier.
 */
public static final int TRANSIENT        = 0x00000080;

/**
 * The {@code int} value representing the {@code native}
 * modifier.
 */
public static final int NATIVE           = 0x00000100;

/**
 * The {@code int} value representing the {@code interface}
 * modifier.
 */
public static final int INTERFACE        = 0x00000200;

/**
 * The {@code int} value representing the {@code abstract}
 * modifier.
 */
public static final int ABSTRACT         = 0x00000400;

/**
 * The {@code int} value representing the {@code strictfp}
 * modifier.
 */
public static final int STRICT           = 0x00000800;
// Bits not (yet) exposed in the public API either because they
// have different meanings for fields and methods and there is no
// way to distinguish between the two in this class, or because
// they are not Java programming language keywords
static final int BRIDGE    = 0x00000040;
static final int VARARGS   = 0x00000080;
static final int SYNTHETIC = 0x00001000;
static final int ANNOTATION  = 0x00002000;
static final int ENUM      = 0x00004000;
static final int MANDATED  = 0x00008000;
```
